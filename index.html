<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Chatbot Luz | Fillsun</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    #chatbot {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 380px;
      height: 600px;
      border-radius: 12px;
      background-color: white;
      box-shadow: 0 0 12px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #chat-header {
      background-color: #f5f5f5;
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #ddd;
    }
    #chat-header img {
      height: 36px;
      margin-bottom: 5px;
    }
    #chat-header div {
      font-weight: bold;
      color: #005377;
    }
    #chat-messages {
      flex-grow: 1;
      padding: 10px;
      overflow-y: auto;
      font-size: 14px;
      color: #444;
      display: flex;
      flex-direction: column;
    }
    .bubble {
      max-width: 75%;
      margin: 6px 0;
      padding: 10px 14px;
      border-radius: 18px;
      line-height: 1.4em;
      display: inline-block;
      word-wrap: break-word;
    }
    .bot {
      background-color: #e3f2fd;
      align-self: flex-start;
      border-top-left-radius: 4px;
    }
    .user {
      background-color: #d0f0c0;
      align-self: flex-end;
      text-align: right;
      border-top-right-radius: 4px;
    }
    .typing-dots {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin-top: 5px;
    }
    .typing-dots span {
      display: inline-block;
      background-color: #bbb;
      width: 8px;
      height: 8px;
      margin-right: 4px;
      border-radius: 50%;
      animation: blink 1.4s infinite both;
    }
    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
    #chat-input {
      display: flex;
      border-top: 1px solid #ccc;
      padding: 8px;
      background: #fff;
    }
    #chat-input input {
      flex-grow: 1;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #aaa;
      border-radius: 20px;
      outline: none;
    }
    #chat-input input:focus {
      border-color: #8bc34a;
      box-shadow: 0 0 0 1px #8bc34a;
    }
    #chat-input button {
      margin-left: 6px;
      background-color: #0077cc;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="chatbot">
  <div id="chat-header">
    <img src="Logo.png" alt="Logo Fillsun">
    <div>Equipo Fillsun en lÃ­nea</div>
  </div>
  <div id="chat-messages"></div>
  <div id="chat-input">
    <input type="text" id="userInput" placeholder="EscribÃ­ tu consulta..." onkeypress="handleKeyPress(event)" />
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>

<script>
let nombreCliente = "";
let interacciones = 0;

function appendMessage(content, clase) {
  const messages = document.getElementById("chat-messages");
  const msg = document.createElement("div");
  msg.className = "bubble " + clase;
  msg.innerHTML = content;
  messages.appendChild(msg);
  messages.scrollTop = messages.scrollHeight;
}

function handleKeyPress(e) {
  if (e.key === "Enter") sendMessage();
}

async function sendMessage() {
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;
  appendMessage("<strong>" + (nombreCliente || "Vos") + ":</strong> " + text, "user");
  input.value = "";

  const loading = document.createElement("div");
  loading.className = "bubble bot";
  loading.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div>`;
  document.getElementById("chat-messages").appendChild(loading);
  document.getElementById("chat-messages").scrollTop = 99999;

  try {
    const res = await fetch("https://chatbot-fillsun.onrender.com/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text })
    });
    const data = await res.json();
    loading.remove();

    if (nombreCliente === "") {
      nombreCliente = text.split(" ").slice(-1)[0];
    }

    appendMessage("<strong>Luz:</strong> " + (data.reply || "Lo siento, no pude responderte."), "bot");

    // Detectar si Luz sugiriÃ³ seguir por WhatsApp
    const respuestaBot = (data.reply || "").toLowerCase();
    const frasesWhatsapp = [
      "seguÃ­ por whatsapp",
      "podÃ©s seguir por whatsapp",
      "te sugiero que sigamos por whatsapp",
      "Â¿querÃ©s que lo hablemos por whatsapp?",
      "podÃ©s escribirnos por whatsapp",
      "contactate por whatsapp",
      "podemos continuar por whatsapp",
      "te paso el whatsapp",
      "te dejo el link de whatsapp"
    ];

    const boton = document.getElementById("whatsapp-button");
    const fraseDetectada = frasesWhatsapp.some(f => respuestaBot.includes(f));

    if (fraseDetectada) {
      const nombre = nombreCliente || "cliente";
      const mensaje = encodeURIComponent(`Hola Fillsun, me llamo ${nombre} y estuve consultando con Luz sobre un producto solar.`);
      boton.href = `https://wa.me/5491123456789?text=${mensaje}`;
      boton.style.display = "block";
    } else {
      boton.style.display = "none";
    }

  } catch (err) {
    loading.remove();
    appendMessage("<strong>Luz:</strong> Error al conectar con el servidor.", "bot");
  }
}

window.onload = () => {
  appendMessage("<strong>Luz:</strong> Â¡Hola! Soy Luz, parte del equipo de Fillsun. Â¿CÃ³mo te llamÃ¡s?", "bot");
};
</script>

<a id="whatsapp-button"
   href="#"
   target="_blank"
   style="display: none; position: fixed; bottom: 80px; right: 20px; background-color: #25d366; color: white; padding: 12px 18px; border-radius: 50px; text-decoration: none; font-weight: bold; z-index: 999;">
   ðŸ“² SeguÃ­ por WhatsApp
</a>

</body>
</html>
