<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Chatbot Luz | Fillsun</title>
  <style>
    html, body {
      background: transparent !important;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    #chatbot.minimizado {
      height: 90px;
      background-color: white;
    }
    #chatbot {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 380px;
      height: 120px;
      border-radius: 12px;
      background-color: white;
      box-shadow: 0 0 12px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: height 0.3s ease;
      z-index: 998;
      cursor: pointer;
    }
    #chatbot.expandido {
      height: 520px;
      cursor: default;
    }
    #chat-header {
      background-color: #f5f5f5;
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    #chat-header img {
      height: 36px;
      margin-bottom: 5px;
    }
    #chat-header div {
      font-weight: bold;
      color: #005377;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #4caf50;
      animation: blink 1.8s infinite;
    }
    @keyframes blink {
      0%, 50%, 100% { opacity: 1; }
      25%, 75% { opacity: 0.2; }
    }
    #minimizar {
      position: absolute;
      top: 6px;
      right: 10px;
      font-size: 18px;
      cursor: pointer;
      color: #999;
    }
    #chat-messages {
      flex-grow: 1;
      padding: 10px;
      overflow-y: auto;
      font-size: 14px;
      color: #444;
      display: none;
      flex-direction: column;
    }
    #chatbot.expandido #chat-messages {
      display: flex;
    }
    #chat-input {
      display: none;
      border-top: 1px solid #ccc;
      padding: 8px;
      background: #fff;
    }
    #chatbot.expandido #chat-input {
      display: flex;
    }
    #chat-input input {
      flex-grow: 1;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #aaa;
      border-radius: 20px;
      outline: none;
    }
    #chat-input input:focus {
      border-color: #8bc34a;
      box-shadow: 0 0 0 1px #8bc34a;
    }
    #chat-input button {
      margin-left: 6px;
      background-color: #0077cc;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 18px;
      cursor: pointer;
    }
    .bubble {
      max-width: 75%;
      margin: 6px 0;
      padding: 10px 14px;
      border-radius: 18px;
      line-height: 1.4em;
      display: inline-block;
      word-wrap: break-word;
    }
    .bot {
      background-color: #e3f2fd;
      align-self: flex-start;
      border-top-left-radius: 4px;
    }
    .user {
      background-color: #d0f0c0;
      align-self: flex-end;
      text-align: right;
      border-top-right-radius: 4px;
    }
    .typing-dots {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin-top: 5px;
    }
    .typing-dots span {
      display: inline-block;
      background-color: #bbb;
      width: 8px;
      height: 8px;
      margin-right: 4px;
      border-radius: 50%;
      animation: blink 1.4s infinite both;
    }
    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
  </style>
</head>
<body>

<div id="chatbot" class="minimizado" onclick="expandirChatbot()">
  <div id="chat-header">
    <div id="minimizar" onclick="minimizarChatbot(event)">&minus;</div>
    <img src="Logo.png" alt="Logo Fillsun">
    <div>Equipo Fillsun en lÃ­nea <span class="status-dot"></span></div>
  </div>
  <div id="chat-messages"></div>
  <div id="chat-input">
    <input type="text" id="userInput" placeholder="EscribÃ­ tu consulta..." onkeypress="handleKeyPress(event)" />
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>

<script>
let ultimoInteres = "";
let nombreCliente = "";
let interacciones = 0;
const URL_PRODUCTOS = "https://chatbot-fillsun.onrender.com/productos_fillsun.json";

function expandirChatbot() {
  const chatbot = document.getElementById("chatbot");
  chatbot.classList.remove("minimizado");
  chatbot.classList.add("expandido");
  chatbot.onclick = null;

  if (interacciones === 0) {
    const historial = JSON.parse(localStorage.getItem("chatHistorial")) || [];
    if (historial.length > 0) {
      historial.forEach(m => appendMessage(m.content, m.clase));
    } else {
      appendMessage("<strong>Luz:</strong> Â¡Hola! Soy Luz â˜€, parte del equipo de Fillsun. Â¿CÃ³mo te llamÃ¡s?", "bot");
    }
    interacciones++;
  }

  window.parent.postMessage("expandir", "*");
}

function minimizarChatbot(e) {
  e.stopPropagation();
  const chatbot = document.getElementById("chatbot");
  chatbot.classList.remove("expandido");
  chatbot.classList.add("minimizado");
  chatbot.onclick = () => expandirChatbot();
  window.parent.postMessage("minimizar", "*");
}

function appendMessage(content, clase) {
  const messages = document.getElementById("chat-messages");
  const msg = document.createElement("div");
  msg.className = "bubble " + clase;
  msg.innerHTML = content;
  messages.appendChild(msg);
  messages.scrollTop = messages.scrollHeight;

  let historial = JSON.parse(localStorage.getItem("chatHistorial")) || [];
  historial.push({ content, clase });
  localStorage.setItem("chatHistorial", JSON.stringify(historial));
}

function handleKeyPress(e) {
  if (e.key === "Enter") sendMessage();
}

async function sendMessage() {
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;
  appendMessage("<strong>" + (nombreCliente || "Vos") + ":</strong> " + text, "user");
  input.value = "";

  if (!text.toLowerCase().includes("whatsapp")) {
    ultimoInteres = text;
  }

  const loading = document.createElement("div");
  loading.className = "bubble bot";
  loading.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div>`;
  document.getElementById("chat-messages").appendChild(loading);
  document.getElementById("chat-messages").scrollTop = 99999;

  try {
    const res = await fetch("https://chatbot-fillsun.onrender.com/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text })
    });
    const data = await res.json();
    loading.remove();

    if (nombreCliente === "") {
      nombreCliente = text.split(" ").slice(-1)[0];
    }

    appendMessage("<strong>Luz:</strong> " + (data.reply || "Lo siento, no pude responderte."), "bot");

    verificarYEnviarContacto(data.reply); // âœ… LÃ­nea agregada

    const respuestaBot = (data.reply || "").toLowerCase();
    const frasesWhatsapp = [
      "seguÃ­ por whatsapp",
      "podÃ©s seguir por whatsapp",
      "te sugiero que sigamos por whatsapp",
      "Â¿querÃ©s que lo hablemos por whatsapp?",
      "podÃ©s escribirnos por whatsapp",
      "contactate por whatsapp",
      "podemos continuar por whatsapp",
      "te paso el whatsapp",
      "te dejo el link de whatsapp",
      "seguimos por whatsapp"
    ];

    const boton = document.getElementById("whatsapp-button");
    const fraseDetectada = frasesWhatsapp.some(f => respuestaBot.includes(f));

    if (fraseDetectada) {
      const nombre = nombreCliente || "cliente";
      const resumen = ultimoInteres || "un producto solar";
      const mensaje = encodeURIComponent(`Hola, me llamo ${nombre} y estuve hablando con Luz sobre: "${resumen}"`);
      boton.href = `https://wa.me/5491133480020?text=${mensaje}`;
      boton.style.display = "block";
    } else {
      boton.style.display = "none";
    }

  } catch (err) {
    loading.remove();
    appendMessage("<strong>Luz:</strong> Error al conectar con el servidor.", "bot");
  }

  try {
    const resp = await fetch(URL_PRODUCTOS);
    const productos = await resp.json();
    const consulta = text.toLowerCase();
    const coincidencias = productos.filter(p =>
      p.nombre.toLowerCase().includes(consulta) ||
      (p.categoria && consulta.includes(p.categoria.toLowerCase())) ||
      (p.tipo && consulta.includes(p.tipo.toLowerCase()))
    );
    if (coincidencias.length > 0) {
      const prod = coincidencias[0];
      const sugerencia = `ðŸ‘‰ Si deseas mirar los productos relacionados: <a href="${prod.url}" target="_blank">${prod.nombre}</a>`;
      appendMessage("<strong>Luz:</strong> " + sugerencia, "bot");
    }
  } catch (err) {
    console.warn("No se pudieron cargar los productos:", err);
  }
}

function verificarYEnviarContacto(respuestaTexto) {
  const contieneMail = respuestaTexto.match(/[\w.-]+@[\w.-]+\.[a-zA-Z]{2,}/);
  const contieneTelefono = respuestaTexto.match(/(\+?\d{2,4}[-.\s]?)?(\d{6,15})/);

  const contacto = contieneMail ? contieneMail[0] : contieneTelefono ? contieneTelefono[0] : null;

  if (contacto && nombreCliente && ultimoInteres) {
    fetch("/enviar-mail", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nombre: nombreCliente, contacto, interes: ultimoInteres })
    }).then(() => {
      console.log("\uD83D\uDCE7 Contacto enviado a ventas Fillsun");
    }).catch(err => console.warn("No se pudo enviar contacto:", err));
  }
}
</script>

<a id="whatsapp-button"
   href="#"
   target="_blank"
   style="display: none; position: fixed; bottom: 100px; right: 20px; background-color: #25d366; color: white; padding: 12px 18px; border-radius: 50px; text-decoration: none; font-weight: bold; z-index: 999;">
   ðŸ“² WhatsApp
</a>

</body>
</html>
